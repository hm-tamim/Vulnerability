<?php

    include 'header.php';




    if($user_type == "admin"){

        $total_villages = $db->rawQuery("SELECT * FROM villages");
        $total_chairmen = $db->rawQuery("SELECT * FROM chairmen");
        $total_people = $db->rawQuery("SELECT * FROM people");
        $total_surveys = $db->rawQuery("SELECT * FROM surveys");


        $total_chairmen = count($total_chairmen);

    } else {


        $total_villages = $db->rawQuery("SELECT village_id FROM chairman_village WHERE chairman_id = '$chairmanid'");

        $village_array = array();

        $i = 0;
        foreach ($total_villages as $village){

            $village_array[$i++] = $village['village_id'];

        }



        $total_chairmen = "1";
        $total_people = $db->rawQuery("SELECT * 
                                              FROM people
                                              WHERE village IN (" . implode(",", $village_array) . ")");

        $total_surveys = $db->rawQuery("SELECT surveys.user_id, people.village
                                              FROM surveys, people
                                              WHERE 
                                              user_id = people.id AND 
                                              village IN (" . implode(",", $village_array) . ")");
    }


    $total_villages = count($total_villages);
    $total_people = count($total_people);
    $total_surveys = count($total_surveys);




?>







        <div class="content">


            <div class="stats">

                <div class="stats-box">
                    <div class="stats-box-inside">
                        <h6>Total Villages</h6>
                        <h2><?php echo $total_villages;?></h2>
                        <i class="far fa-map-marker-alt"></i>

                    </div>
                </div><div class="stats-box">
                    <div class="stats-box-inside">
                        <h6>Chairmen</h6>
                        <h2><?php echo $total_chairmen;?></h2>
                        <i class="far fa-users-crown"></i>
                    </div>
                </div><div class="stats-box">
                    <div class="stats-box-inside">
                        <h6>People</h6>
                        <h2><?php echo $total_people;?></h2>
                        <i class="far fa-user-friends"></i>
                    </div>
                </div><div class="stats-box">
                    <div class="stats-box-inside">
                        <h6>Surveys Taken</h6>
                        <h2><?php echo $total_surveys;?></h2>
                        <i class="far fa-poll-people"></i>
                    </div>
                </div>


            </div>




            <?php

            if($user_type == "admin") {
                $survey_people = $db->rawQuery("SELECT surveys.user_id, people.*, (q1+q2+q3+q4+q5+q6+q7+q8+q9)/9 as avgg
                            FROM surveys, people
                            WHERE
                            user_id = people.id
                            ");
            }else{


                $survey_people = $db->rawQuery("SELECT surveys.user_id, people.*, (q1+q2+q3+q4+q5+q6+q7+q8+q9)/9 as avgg
                            FROM surveys, people
                            WHERE
                            user_id = people.id AND
                            village IN (" . implode(",", $village_array) . ")
                            ");

            }

            ?>



            <div class="single-line">
                <div class="left">
                    <div class="brd c-left">
                        <p>Statistics</p> <br>
                        <div id="chartContainer" style="height: 300px;"></div>
                    </div>
                </div>

                <div class="right">
                    <div class="brd c-left">
                        <p>Vulnerability Ratio</p><br>
                        <div id="chartContainerPie" style="height: 300px;"></div>
                    </div>
                </div>
            </div>





<!--            table starts-->





            <div class="single-line list-holder">
                <div class="one">
                    <div class="brd c-left">
                        <p>High Vulnerable Group</p> <br>

                        <table>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Points</th>
                            </tr>


                            <?php

                            $high_count = 0;

                            foreach ($survey_people as $sp){

                                if ($sp['avgg'] < 3) {
                                    echo '<tr> <td> ' . $sp['name'] . '</td> <td> ' . $sp['phone'] . '</td> <td> ' . $sp['avgg'] . '</td></tr>';
                                    $high_count++;
                                }
                            }
                            ?>

                        </table>



                        <button style="margin-left: 20px;
    margin-bottom: 19px;
    padding: 5px 23px;
    background: #31708f;
    border: 0;
    color: #fff;
    border-radius: 4px;
    margin-top: 10px;">
                            Print
                        </button>

                    </div>
                </div>

                <div class="two">
                    <div class="brd c-left">
                        <p>Medium Vulnerable Group</p><br>

                        <table>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Points</th>
                            </tr>



                            <?php

                            $mid_count = 0;

                            foreach ($survey_people as $sp){

                                if ($sp['avgg'] < 4 && $sp['avgg'] > 3) {
                                    echo '<tr> <td> ' . $sp['name'] . '</td> <td> ' . $sp['phone'] . '</td> <td> ' . $sp['avgg'] . '</td></tr>';

                                    $mid_count++;

                                }

                            }
                            ?>

                        </table>

                        <button style="margin-left: 20px;
    margin-bottom: 19px;
    padding: 5px 23px;
    background: #31708f;
    border: 0;
    color: #fff;
    border-radius: 4px;
    margin-top: 10px;">
                            Print
                        </button>

                    </div>
                </div>
                <div class="three">
                    <div class="brd c-left">
                        <p>Low Vulnerable Group</p><br>
                        <table>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Points</th>
                            </tr>



                            <?php

                            foreach ($survey_people as $sp){

                                $low_count = 0;

                                if ($sp['avgg'] > 4) {
                                    echo '<tr> <td> ' . $sp['name'] . '</td> <td> ' . $sp['phone'] . '</td> <td> ' . $sp['avgg'] . '</td></tr>';
                                    $low_count++;

                                }

                            }
                            ?>

                        </table>

                        <button style="margin-left: 20px;
    margin-bottom: 19px;
    padding: 5px 23px;
    background: #31708f;
    border: 0;
    color: #fff;
    border-radius: 4px;
    margin-top: 10px;">
                            Print
                        </button>


                    </div>
                </div>
            </div>


        </div>

    </div>




    </div>



    <script>


        var options = {
            animationEnabled: true,
            title: {
                text: ""
            },
            axisY: {

                interval: 10,
                minimum: 0,
                maximum: <?php echo count($survey_people);?>,
                labelFontSize:13,
                gridColor: "#ddd",

            },

            axisX: {

                labelFontSize:14,
                gridColor: "#ddd",
                labelAngle: 0,
                labelWrap: true,

            },
            data: [{
                type: "column",
                indexLabelPlacement: "inside",
                indexLabelFontColor: "white",
                indexLabelFontWeight: 600,
                yValueFormatString: "#",
                indexLabel: "{y}",
                indexLabelFontSize: 15,
                dataPoints: [
                    { label: "Total People", y: <?php echo count($survey_people); ?> },
                    { label: "High Vulnerable", y: <?php echo $high_count; ?>, color: "#f5584e"},
                    { label: "Medium Vulnerable", y: <?php echo $mid_count; ?> },
                    { label: "Low Vulnerable", y: <?php echo $low_count; ?>,color:"#269ea9", },

                ]
            }]
        };



        $("#chartContainer").CanvasJSChart(options);


    </script>

    <script type="text/javascript">
        window.onload =function() {
            var chart = new CanvasJS.Chart("chartContainerPie",{
                animationEnabled: true,
                title: {
                    text: "",
                    fontColor: "#333",
                    fontSize: 20,
                    fontWeight: 50,
                },
                data: [
                    {
                        showInLegend: true,
                        type: "pie",
                        indexLabel: "#percent%",
                        percentFormatString: "#0.##",
                        toolTipContent: "{label} (#percent%)",
                        dataPoints: [

                            {  label: "High Vulnerable", y: 35.2,  color: "#f5584e", name: "High Vulnerable",},
                            {  label: "Medium Vulnerable", y: 46.5, color: "#4f81bd", name: "Medium Vulnerable",},
                            {  label: "Low Vulnerable", y: 18.1, color: "#9bbc58", name: "Low Vulnerable",},

                        ]
                    }
                ]
            });
            chart.render();
        }
    </script>

<?php

include 'footer.php';

?>