<?php

include 'header.php';
echo '<div class="content">';


if(isset($_REQUEST['add-village'])){


    $name = $_REQUEST['name'];
    $password = $_REQUEST['password'];
    //$village_id = $_REQUEST['village'];
    $email = $_REQUEST['email'];


    $data = Array (
        "name" => $name,
        "email" => $email,
        "password" => $password,
    );


    $check = $db->rawQuery("SELECT id from chairmen WHERE email LIKE '%$email%'");

    $id = $check;

    if(!$check) {
        $id = $db->insert('chairmen', $data);
        if ($id)
            echo '<div class="toast">Chairman account has successfully added to database.</div>';
    } else{
        $id  = $check;
    }


    foreach ($_REQUEST['village'] as $selectedOption)
    {

        $chair_id = $id[0]['id'];
        $data2 = Array (
            "chairman_id" => $chair_id,
            "village_id" =>  $selectedOption,
        );
        $id2 = $db->insert ('chairman_village', $data2);

        if ($id2)
            echo '<div class="toast">Village has added to chairman profile.</div>';

    }


}


?>

        <div class="single-line add-form"">
        <div class="">
            <div class="brd c-left">
                <p>Add Chairman Account</p> <br>
                <form action="" method="post">
                    <div class="select-holder chairmen">
                        <select id="locality-dropdown" name="district" required>
                        </select>
                        <select id="upazila" name="upazila" required>
                        </select>
                        <select id="union" name="union">
                        </select>

                        <select id="village" name="village[]" required multiple="multiple">
                        </select>
                    </div>

                    <br>

                    <div class="chairmen-input">

                        <div class="ileft">
                            <label for="email">Email address</label>
                            <input name="email" type="text" placeholder="Enter chairman email" required/>
                        </div>

                        <div class="icright">
                            <label for="password">Password</label>
                            <input name="password" type="text" value="<?php echo randomPassword(); ?>" placeholder="Enter a password" required/>
                        </div>
                    </div>

                    <div class="">
                        <input name="name" type="text" placeholder="Enter chairman name" required/>
                        <input type="submit" name="add-village" value="Add" required/>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        $(document).ready(function() {
            $('#village').multiselect();
        });
    </script>


    <div class="single-line mt20">
        <div class="">
            <div class="brd c-left list-holder village-list">
                <p>List of Chairmen</p> <br>




                <table>
                    <tr><th>Name</th> <th>Email</th> <th>Password</th> <th>Villages</th> <th>District</th> <th>Upazila</th> <th>Union</th></tr>

                    <?php

                    $list = $db->rawQuery('SELECT chairmen.name as chairman_name, chairmen.email, chairmen.password, chairmen.id
                                          FROM  chairmen');

                    foreach($list as $item){


                        $chairman_id = $item['id'];

                        $sub_list = $db->rawQuery("SELECT chairman_id, village_id,
                                                villages.name as village_name, 
                                                districts.bn_name as district_name, 
                                                upazilas.bn_name as upazila_name,
                                                unionz.bn_name as union_name
                                          FROM  chairman_village, villages, districts, upazilas, unions as unionz
                                          
                                          WHERE 
                                                chairman_id = '$chairman_id' AND
                                                village_id = villages.id AND
                                                upazilas.id = villages.upazila AND
                                                districts.id = upazilas.district_id AND
                                                unionz.id = villages.unions");

                        echo '<tr><td>'.$item['chairman_name'].'</td> <td>'.$item['email'].'</td> <td>'.$item['password'].'</td> <td>';

                        foreach($sub_list as $sub_item){
                                echo $sub_item['village_name'] . ", ";
                        }
                        
                        
                        echo '</td> <td>'.$sub_list[0]['district_name'].'</td> <td>'.$sub_list[0]['upazila_name'].'</td> <td>'.$sub_list[0]['union_name'].'</td></tr>';


                    }


                    ?>

                </table>





            </div>
        </div>
    </div>



<script>


    function(n) {
        if (n) {
            var l = parseInt(p(n).username);
            if (l && "number" == typeof l) {
                var e = l.toString();
                if (e.length > 4) {
                    console.log(e);
                    var t = 8 * parseInt(e.slice(-4)) - 2019
                }
            } else
                t = Math.floor(9e4 * Math.random()) + 1e4
        }
        return btoa(t + "")
    }


</script>


    <script>

        let dropdown1 = $('#locality-dropdown');

        dropdown1.empty();

        dropdown1.append('<option selected="true" disabled>Choose districts</option>');
        dropdown1.prop('selectedIndex', 0);

        url = '/api/districts.php';

        // Populate dropdown with list of provinces
        $.getJSON(url, function (data) {
            $.each(data, function (key, entry) {
                dropdown1.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
            })
        });




        dropdown1.change(function(){

            var selected = $(this).children("option:selected").val();




            let dropdown2 = $('#upazila');

            dropdown2.empty();

            dropdown2.removeAttr('disabled');

            dropdown2.append('<option selected="true" disabled>Choose upazila</option>');
            dropdown2.prop('selectedIndex', 0);

            url = '/api/upazilas.php?district='+selected;

            // Populate dropdown with list of provinces
            $.getJSON(url, function (data) {
                $.each(data, function (key, entry) {
                    dropdown2.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
                })
            });



            dropdown2.change(function(){

                var selected2 = $(this).children("option:selected").val();

                let dropdown3 = $('#union');
                dropdown3.empty();
                dropdown3.removeAttr('disabled');

                dropdown3.append('<option selected="true" disabled>Choose union</option>');
                dropdown3.prop('selectedIndex', 0);

                url = '/api/unions.php?upazila='+selected2;

                // Populate dropdown with list of provinces
                $.getJSON(url, function (data) {
                    $.each(data, function (key, entry) {
                        dropdown3.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
                    })
                });



                dropdown3.change(function () {


                    var selected3 = $(this).children("option:selected").val();

                    let dropdown4 = $('#village');
                    dropdown4.empty();
                    //dropdown4.append('<option selected="true" disabled>Choose villages</option>');
                    //dropdown4.prop('selectedIndex', 0);


                    $('#village').multiselect('deselectAll', true);


                    url = '/api/villages.php?union=' + selected3;

                    // Populate dropdown with list of provinces
                    $.getJSON(url, function (data) {
                        $.each(data, function (key, entry) {
                            dropdown4.append($('<option></option>').attr('value', entry.id).text(entry.name));
                        });


                        $("#village").multiselect("rebuild");

                    });
                })


            });






        });




    </script>


    <script>

        let dropdown2 = $('#upazila');
        dropdown2.empty();
        dropdown2.attr('disabled','disabled');
        dropdown2.append('<option selected="true" disabled>Choose upazila</option>');
        dropdown2.prop('selectedIndex', 0);

    </script>


    <script>

        let dropdown3 = $('#union');
        dropdown3.empty();
        dropdown3.attr('disabled','disabled')
        dropdown3.append('<option selected="true" disabled>Choose union</option>');
        dropdown3.prop('selectedIndex', 0);

    </script>


    <script>

        let dropdown4 = $('#village');
        dropdown4.empty();
        dropdown4.append('<option selected="true" disabled>Choose villages</option>');
        dropdown4.prop('selectedIndex', 0);


        // url = '/api/villages.php';
        //
        // // Populate dropdown with list of provinces
        // $.getJSON(url, function (data) {
        //     $.each(data, function (key, entry) {
        //         dropdown4.append($('<option></option>').attr('value', entry.id).text(entry.name));
        //     })
        // });

    </script>



<?php

include 'footer.php';

?>