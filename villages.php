<?php

include 'header.php';

echo '<div class="content">';


if(isset($_REQUEST['add-village'])){


    $upazila = $_REQUEST['upazila'];

    if(isset($_REQUEST['union']))
        $union = $_REQUEST['union'];
    else
        $union = "";


    $name = $_REQUEST['title'];


    $data = Array ("name" => $name,
        "upazila" => $upazila,
        "unions" => $union
    );
    $id = $db->insert ('villages', $data);
    if($id)
        echo '<div class="toast">Village has successfully added to database.</div>';



}


?>


        <div class="single-line add-form"">
            <div class="">
                <div class="brd c-left">
                    <p>Add Villages</p> <br>
                    <form action="" method="post">
                        <div class="select-holder">
                            <select id="locality-dropdown" name="district" required>
                            </select>
                            <select id="upazila" name="upazila">
                            </select>
                            <select id="union" name="union">
                            </select>
                        </div>

                        <input name="title" type="text" placeholder="Enter village name" required/>
                        <input type="submit" name="add-village" value="Add"/>
                    </form>
                </div>
            </div>
        </div>





    <div class="single-line mt20">
    <div class="">
        <div class="brd c-left list-holder village-list">
            <p>List of Villages</p> <br>

            <table>
                <tr><th>Name</th> <th>District</th> <th>Upazila</th> <th>Union</th></tr>

            <?php

            $list = $db->rawQuery('SELECT villages.id, villages.name, 
                                                districts.bn_name as district_name, 
                                                upazilas.bn_name as upazila_name,
                                                unionz.bn_name as union_name
                                          FROM  villages, districts, upazilas, unions as unionz
                                          
                                          WHERE districts.id = villages.district AND
                                                upazilas.id = villages.upazila AND
                                                unionz.id = villages.unions');

            foreach($list as $item){



                echo '<tr><td>'.$item['name'].'</td> <td>'.$item['district_name'].'</td> <td>'.$item['upazila_name'].'</td> <td>'.$item['union_name'].'</td></tr>';


            }


            ?>


        </div>
    </div>
    </div>


<script>

    let dropdown1 = $('#locality-dropdown');

    dropdown1.empty();

    dropdown1.append('<option selected="true" disabled>Choose districts</option>');
    dropdown1.prop('selectedIndex', 0);

    url = '/api/districts.php';

    // Populate dropdown with list of provinces
    $.getJSON(url, function (data) {
        $.each(data, function (key, entry) {
            dropdown1.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
        })
    });




    dropdown1.change(function(){

        var selected = $(this).children("option:selected").val();




        let dropdown2 = $('#upazila');

        dropdown2.empty();

        dropdown2.removeAttr('disabled');

        dropdown2.append('<option selected="true" disabled>Choose upazila</option>');
        dropdown2.prop('selectedIndex', 0);

        url = '/api/upazilas.php?district='+selected;

        // Populate dropdown with list of provinces
        $.getJSON(url, function (data) {
            $.each(data, function (key, entry) {
                dropdown2.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
            })
        });



        dropdown2.change(function(){

            var selected2 = $(this).children("option:selected").val();

            let dropdown3 = $('#union');
            dropdown3.empty();
            dropdown3.removeAttr('disabled');

            dropdown3.append('<option selected="true" disabled>Choose union</option>');
            dropdown3.prop('selectedIndex', 0);

            url = '/api/unions.php?upazila='+selected2;

            // Populate dropdown with list of provinces
            $.getJSON(url, function (data) {
                $.each(data, function (key, entry) {
                    dropdown3.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
                })
            });


        });






    });




</script>


    <script>

        let dropdown2 = $('#upazila');
        dropdown2.empty();
        dropdown2.attr('disabled','disabled');
        dropdown2.append('<option selected="true" disabled>Choose upazila</option>');
        dropdown2.prop('selectedIndex', 0);

    </script>


    <script>

        let dropdown3 = $('#union');
        dropdown3.empty();
        dropdown3.attr('disabled','disabled')
        dropdown3.append('<option selected="true" disabled>Choose union</option>');
        dropdown3.prop('selectedIndex', 0);

    </script>




<?php

include 'footer.php';

?>